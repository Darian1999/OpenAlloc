CC = gcc
CFLAGS = -Wall -Wextra -O3 -march=native -std=c11 -D_POSIX_C_SOURCE=199309L
LDFLAGS = -lpthread

# Sources
OPENALLOC_SRC = openalloc.c
TEST_ALLOCATOR_SRC = test_allocator.c
ORIGINAL_TEST_SRC = test.c

# Objects
OPENALLOC_OBJ = $(OPENALLOC_SRC:.c=.o)
TEST_ALLOCATOR_OBJ = $(TEST_ALLOCATOR_SRC:.c=.o)
ORIGINAL_TEST_OBJ = $(ORIGINAL_TEST_SRC:.c=.o)

# Executables
TEST_ALLOCATOR_BIN = test_allocator
ORIGINAL_TEST_BIN = test_orig

.PHONY: all clean test test-allocator benchmark test-full help

all: $(TEST_ALLOCATOR_BIN) $(ORIGINAL_TEST_BIN)

$(TEST_ALLOCATOR_BIN): $(OPENALLOC_OBJ) $(TEST_ALLOCATOR_OBJ)
	$(CC) $(CFLAGS) -o $@ $^ $(LDFLAGS)

$(ORIGINAL_TEST_BIN): $(OPENALLOC_OBJ) $(ORIGINAL_TEST_OBJ)
	$(CC) $(CFLAGS) -o $@ $^

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

run-test: $(ORIGINAL_TEST_BIN)
	@echo "Running original test suite..."
	@./$(ORIGINAL_TEST_BIN)

run-test-allocator: $(TEST_ALLOCATOR_BIN)
	@echo "Running comprehensive allocator test suite..."
	@./$(TEST_ALLOCATOR_BIN)

benchmark: $(TEST_ALLOCATOR_BIN)
	@echo "Running performance benchmark..."
	@./$(TEST_ALLOCATOR_BIN) 12345

test-full: run-test run-test-allocator

clean:
	rm -f $(OPENALLOC_OBJ) $(TEST_ALLOCATOR_OBJ) $(ORIGINAL_TEST_OBJ)
	rm -f $(TEST_ALLOCATOR_BIN) $(ORIGINAL_TEST_BIN)

help:
	@echo "Available targets:"
	@echo "  all          - Build all executables"
	@echo "  run-test     - Run original test suite"
	@echo "  run-test-allocator - Run comprehensive test suite"
	@echo "  benchmark    - Run performance benchmark"
	@echo "  test-full    - Run all tests"
	@echo "  clean        - Remove build artifacts"
	@echo "  help         - Show this help message"
